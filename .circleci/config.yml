version: 2
jobs:
  build:
    docker:
      - image: docker:18.09.3-git
    steps:
      - setup_remote_docker:
          version: 18.09.3
      - checkout
      - run : |
          # export COMMIT_SHA=$(git log -1 --pretty=format:"%H" | awk '{print substr($1,1,8)}') 
          # docker login -u $DOCKER_HUB_USER -p $DOCKER_HUB_PWD
          # docker build --build-arg COMMIT_SHA=${COMMIT_SHA} -t setzero/kubeadm-ha:${CIRCLE_BRANCH}-${COMMIT_SHA} .
          # docker push setzero/kubeadm-ha:${CIRCLE_BRANCH}-${COMMIT_SHA}

          image_list="
          openresty/openresty:1.17.8.2-alpine
          nginx:1.17.9-alpine
          haproxy:2.1-alpine
          envoyproxy/envoy:v1.16.0
          osixia/keepalived:2.0.20
          quay.io/coreos/flannel:v0.13.0
          calico/typha:v3.16.5
          calico/cni:v3.16.5
          calico/node:v3.16.5
          calico/kube-controllers:v3.16.5
          calico/pod2daemon-flexvol:v3.16.5
          calico/ctl:v3.16.5
          k8s.gcr.io/ingress-nginx/controller:v0.41.0
          jettech/kube-webhook-certgen:v1.5.0
          traefik:2.2.1
          kubernetesui/dashboard:v2.0.0
          kubernetesui/metrics-scraper:v1.0.4
          quay.io/jetstack/cert-manager-cainjector:v0.9.1
          quay.io/jetstack/cert-manager-webhook:v0.9.1
          quay.io/jetstack/cert-manager-controller:v0.9.1
          "
          
          new_docker_registry=${NEW_DOCKER_REGISTRY:-'registry.cn-shanghai.aliyuncs.com/kubeadm-ha'}
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD ${new_docker_registry%%/*}
          for image in $image_list ; do 
            count=$(echo $image | grep -o '/*' | wc -l)
            if [ $count -eq 0 ]
            then
              new=$new_docker_registry/$image
            elif [ $count -eq 1 ]
            then
              new=$new_docker_registry/$(echo ${image} | sed 's / _ g')
            else
              new=$new_docker_registry/$(echo ${image#*/} | sed 's / _ g')
            fi
            echo "FROM $image" > Dockerfile
            docker build -t $new .
            docker push $new
          done
workflows:
  version: 2
  build:
    jobs:
    - build